%% Session Lifecycle: Checkpoint creation, updates, and cleanup
%% Render: cat session-lifecycle-sequence.mmd | mermaid-ascii -f -
%% Focus: State persistence in .git/bumper-checkpoints/

sequenceDiagram
    participant CC as Claude Code
    participant Bin as ensure-binaries.sh
    participant Hook as Hooks
    participant Git
    participant FS as .git/bumper-checkpoints/
    participant Cfg as Config Files

    %% === BINARY VERSION CHECK (ensure-binaries.sh) ===
    CC->>Bin: SessionStart (first)
    Bin->>Cfg: read plugin.json version
    Cfg-->>Bin: "2.0.2"
    Bin->>FS: read bin/.build-version
    FS-->>Bin: "2.0.1" (or missing)
    Bin->>Bin: go build (version mismatch)
    Bin->>FS: write "2.0.2" to .build-version
    Bin-->>CC: stderr: ready v2.0.2

    %% === SESSION START ===
    CC->>Hook: bumper-lanes session-start
    Hook->>Git: git rev-parse --absolute-git-dir
    Git-->>Hook: /path/to/.git
    Hook->>Git: git write-tree
    Git-->>Hook: baseline tree SHA abc123
    Hook->>Git: git branch --show-current
    Git-->>Hook: main
    Hook->>Cfg: load threshold
    Cfg-->>Hook: 400 (default or config)

    %% Create checkpoint directory and state file
    Hook->>FS: mkdir bumper-checkpoints/
    Hook->>FS: write session-{id}.tmp
    Hook->>FS: rename to session-{id}
    FS-->>Hook: state saved

    %% Cleanup orphaned checkpoints from crashed sessions
    Hook->>FS: ReadDir bumper-checkpoints/
    FS-->>Hook: list of session-* files
    Hook->>Hook: filter: skip current session, skip .tmp
    Hook->>FS: delete orphaned session files
    FS-->>Hook: (log to stderr, ignore errors)

    %% Idempotent auto-setup check
    Hook->>Hook: setupStatusLineWrapper()
    Hook-->>CC: (configure/wrap statusLine if needed)

    %% === DURING SESSION (each hook call) ===
    CC->>Hook: PostToolUse / Stop
    Hook->>FS: read session-{id}
    FS-->>Hook: SessionState JSON
    Hook->>Hook: (update score, flags)
    Hook->>FS: write session-{id}.tmp
    Hook->>FS: rename to session-{id}
    FS-->>Hook: atomic save complete

    %% === SESSION END ===
    CC->>Hook: SessionEnd
    Hook->>FS: delete session-{id}
    FS-->>Hook: (ignore errors)
    Hook-->>CC: cleanup complete

%% ============================================================
%% VALIDATION REFERENCES
%% ============================================================
%% - ensure-binaries.sh: scripts/ensure-binaries.sh (version sentinel)
%% - SessionStart: internal/hooks/session_start.go:28-70
%% - setupStatusLineWrapper: internal/hooks/session_start.go:115-185
%% - State New(): internal/state/session.go:135-152
%% - State Save(): internal/state/session.go:91-132 (atomic write)
%% - State Load(): internal/state/session.go:67-87
%% - State Delete(): internal/state/session.go:155-161
%% - CleanupOrphaned(): internal/state/session.go:209-254
%% - SessionEnd: internal/hooks/session_end.go:9-13
%% - Checkpoint dir: internal/state/session.go:36-44
%%
%% STATE FILE LOCATION
%% Path: {git-dir}/bumper-checkpoints/session-{session_id}
%% - Uses --absolute-git-dir for worktree support
%% - Each worktree gets isolated checkpoints
%%
%% STATE FILE CONTENTS (JSON)
%% {
%%   "session_id": "abc123",
%%   "baseline_tree": "def456",
%%   "baseline_branch": "main",
%%   "score": 125,
%%   "threshold_limit": 400,
%%   "stop_triggered": false,
%%   "paused": false,
%%   "view_mode": "tree",
%%   "view_opts": "--width 80",
%%   "created_at": "2024-01-15T10:30:00Z",
%%   "repo_path": "/path/to/repo"
%% }
%%
%% ATOMIC WRITES
%% 1. Write to session-{id}.tmp
%% 2. Rename to session-{id}
%% Prevents race conditions between parallel hooks
%%
%% VERSION SENTINEL
%% Path: bin/.build-version
%% - Contains plugin version that binaries were built for
%% - Compared against .claude-plugin/plugin.json on SessionStart
%% - Triggers rebuild on version mismatch (plugin update scenario)
%% - Fast path (~33ms) when version matches and binaries exist
%%
%% PAIN POINTS
%% 1. State read/write on every hook call (I/O overhead)
%% 2. [RESOLVED] Orphaned checkpoints cleaned on SessionStart (CleanupOrphaned)
%% 3. [RESOLVED] Temp files skipped during cleanup (may be in-progress writes)
%% 4. No state versioning - schema changes break old files
