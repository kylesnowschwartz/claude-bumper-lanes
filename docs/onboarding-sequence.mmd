%% Onboarding Flow: Plugin install â†’ working status line
%% Render: cat onboarding-sequence.mmd | mermaid-ascii -f -
%% Focus: User-facing steps only (internal details omitted)

sequenceDiagram
    participant User
    participant CLI as Claude CLI
    participant CC as Claude Code
    participant FS as ~/.claude/

    %% Phase 1: Plugin Installation (two commands)
    User->>CLI: marketplace add kylesnowschwartz/claude-bumper-lanes
    CLI-->>User: plugin added

    User->>CLI: plugin install claude-bumper-lanes
    CLI-->>User: plugin installed

    %% Phase 2: First Session (auto-setup)
    User->>CC: start session in git repo
    CC->>CC: version check (plugin.json vs .build-version)
    CC->>CC: (builds Go binaries ~15s if new/updated)

    %% Auto-setup status line
    alt Script contains # BUMPER_HANDS_OFF
        Note over CC: User opted out - skip all auto-setup
        CC-->>CC: (silent - no modification)
    else No existing status line
        CC->>FS: set statusLine.command to binary path (via jq)
        CC-->>User: stderr: Status line configured! Restart session.
    else Existing status line (first time)
        CC->>FS: generate wrapper at ~/.claude/bumper-lanes-statusline-wrapper.sh
        Note over FS: Wrapper includes BUMPER_BIN marker for staleness detection
        CC->>FS: update statusLine.command to wrapper (via jq)
        CC-->>User: stderr: Wrapped your status line. Restart session.
    else Existing wrapper (plugin updated)
        CC->>FS: check BUMPER_BIN marker vs current binary path
        CC->>FS: regenerate wrapper with new binary path
        CC-->>User: stderr: Updated wrapper for new version. Restart session.
    end

    %% Phase 3: Working
    User->>CC: restart session
    CC-->>User: diff tree visible in status line

%% ============================================================
%% VALIDATION REFERENCES
%% ============================================================
%% - Plugin install: README.md:24-27
%% - Version sentinel: scripts/ensure-binaries.sh
%% - Hands-off check: internal/hooks/session_start.go:isHandsOff()
%% - Auto-setup: internal/hooks/session_start.go:setupStatusLineWrapper()
%% - Wrapper generation: internal/hooks/session_start.go:generateWrapper()
%% - Staleness check: internal/hooks/session_start.go:isWrapperStale()
%% - Binary path extraction: internal/hooks/session_start.go:getWrapperBinaryPath()
%% - Settings update: internal/hooks/session_start.go:updateSettingsWithJq()
%%
%% RESOLVED PAIN POINTS (v2.1.0+)
%% 1. Two CLI commands required - UNCHANGED (Claude Code limitation)
%% 2. 10-15s compile delay - UNCHANGED (Go build required)
%% 3. One-time stderr prompt easy to miss - NOW: auto-setup, no action needed
%% 4. Manual JSON editing required - NOW: auto via jq
%% 5. Session restart required - UNCHANGED (Claude Code limitation)
%% 6. Wrapper stale after plugin update - NOW: auto-regenerate via BUMPER_BIN marker
%% 7. Auto-setup modifies user scripts - NOW: # BUMPER_HANDS_OFF escape hatch
%%
%% Status line auto-setup is now idempotent (checks actual state each session)
