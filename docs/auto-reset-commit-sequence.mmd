%% Auto-Reset: Invisible baseline capture when tree becomes clean
%% Render: cat auto-reset-commit-sequence.mmd | mermaid-ascii -f -
%% Focus: The "magic" that resets budget after commits (any source)

sequenceDiagram
    participant User
    participant Claude
    participant PreTU as PreToolUse
    participant PTU as PostToolUse
    participant Git
    participant Sess as Session

    %% ============================================================
    %% CASE 1: Claude commits via Bash tool
    %% ============================================================
    Note over User,Sess: Scenario 1: Claude commits
    User->>Claude: finish up and commit
    Claude->>Claude: (score at 350/400)

    %% Claude commits via Bash tool
    Claude->>Git: git commit -m "feat: add feature"
    Git-->>Claude: committed abc123

    %% PostToolUse fires for Bash
    PTU->>PTU: (regex matches git commit)
    PTU->>Git: CaptureTree()
    Git-->>PTU: tree SHA def456

    %% Reset baseline to committed state
    PTU->>Sess: baseline = def456
    PTU->>Sess: score = 0
    PTU-->>Claude: stderr: Auto-reset. Fresh budget: 400 pts.
    Claude-->>User: Committed. Fresh budget now.

    %% ============================================================
    %% CASE 2: PreToolUse auto-reset (v3.7.0)
    %% ============================================================
    Note over User,Sess: Scenario 2: PreToolUse catches external commit
    Note over User,Claude: (Threshold exceeded - StopTriggered=true)
    User->>Git: git commit (in IDE/terminal)
    Git-->>User: committed jkl012
    User->>Claude: continue working

    %% Claude attempts Write - PreToolUse fires BEFORE execution
    Claude->>PreTU as PreToolUse: (wants to Write file)

    %% PreToolUse checks state
    PreTU->>Sess: Load session
    Sess-->>PreTU: StopTriggered=true, score=450/400

    %% Auto-reset check (NEW in v3.7.0)
    Note over PreTU,Git: Clean tree check (handles external commits)
    PreTU->>Git: CaptureTree()
    Git-->>PreTU: tree SHA jkl012
    PreTU->>Git: GetHeadTree()
    Git-->>PreTU: HEAD tree jkl012

    %% Trees match - auto-reset and allow
    PreTU->>PreTU: (tree == HEAD, clean!)
    PreTU->>Git: GetCurrentBranch()
    Git-->>PreTU: main
    PreTU->>Sess: ResetBaseline(jkl012, main)
    PreTU->>Sess: StopTriggered = false
    PreTU->>Sess: score = 0

    %% Allow Write to proceed (no JSON output)
    PreTU-->>Claude: exit 0 (allow tool)
    Note over PreTU,Claude: No JSON = tool proceeds normally

    %% Write executes successfully
    Claude->>Git: Write file
    Git-->>Claude: file written

    %% PostToolUse calculates new score and provides feedback
    PTU->>PTU: handleWriteEdit()
    PTU->>Git: calculate diff from jkl012
    Git-->>PTU: score = 15 pts (just this Write)
    PTU->>Sess: score = 15
    PTU-->>Claude: stderr: Fresh budget after auto-reset. Score: 15/400 (3%)
    Claude-->>User: Changes made. Fresh budget: 15/400.

    %% ============================================================
    %% CASE 3: PreToolUse auto-recovery (v3.8.0 - PR #3 fix)
    %% ============================================================
    Note over User,Sess: Scenario 3: User reduces diff below threshold (tree still dirty)
    Note over User,Claude: (Threshold exceeded - StopTriggered=true)
    User->>Git: rm large-file.ts (via IDE/terminal)
    Git-->>User: file removed (but other changes remain)
    User->>Claude: continue working

    %% Claude attempts Write - PreToolUse fires BEFORE execution
    Claude->>PreTU as PreToolUse: (wants to Write file)

    %% PreToolUse checks state
    PreTU->>Sess: Load session
    Sess-->>PreTU: StopTriggered=true, score=600/400

    %% Check if tree is clean (it's not)
    Note over PreTU,Git: Tree dirty check (v3.8.0 recalculates score)
    PreTU->>Git: CaptureTree()
    Git-->>PreTU: tree SHA xyz789
    PreTU->>Git: GetHeadTree()
    Git-->>PreTU: HEAD tree jkl012

    %% Trees don't match (dirty) - NEW: recalculate score
    PreTU->>PreTU: (tree != HEAD, dirty - recalculate)
    PreTU->>Git: calculate diff from baseline
    Git-->>PreTU: freshScore = 280 pts (removed large-file.ts)

    %% Score dropped below threshold - auto-recover!
    PreTU->>PreTU: (280 <= 400, below threshold!)
    PreTU->>Sess: StopTriggered = false
    PreTU->>Sess: score = 280

    %% Allow Write to proceed (no JSON output)
    PreTU-->>Claude: exit 0 (allow tool)
    PreTU-->>Claude: stderr: âœ“ Auto-recovered: 280/400 (70%). External changes reduced diff.
    Note over PreTU,Claude: No JSON = tool proceeds normally

    %% Write executes successfully
    Claude->>Git: Write file
    Git-->>Claude: file written

    %% PostToolUse calculates new score including this Write
    PTU->>PTU: handleWriteEdit()
    PTU->>Git: calculate diff from baseline
    Git-->>PTU: score = 295 pts (280 + this Write)
    PTU->>Sess: score = 295
    PTU-->>Claude: stderr: Score: 295/400 (73%)
    Claude-->>User: Changes made. Score: 295/400.

    %% ============================================================
%% VALIDATION REFERENCES
%% ============================================================
%% Scenario 1 (Claude commits):
%% - Commit detection: internal/hooks/post_tool_use.go:gitCommitPattern
%% - Tree capture: internal/hooks/post_tool_use.go:handleBashCommit (line 64)
%% - Reset call: internal/hooks/post_tool_use.go:handleBashCommit (line 72)
%% - Feedback: internal/hooks/post_tool_use.go:handleBashCommit (line 79)
%%
%% Scenario 2 (PreToolUse auto-reset on clean tree, v3.7.0):
%% - StopTriggered check: internal/hooks/pre_tool_use.go:88
%% - Tree capture: internal/hooks/pre_tool_use.go:89
%% - HEAD tree check: internal/hooks/pre_tool_use.go:94-98
%% - Clean tree detection: internal/hooks/pre_tool_use.go:101
%% - Reset call: internal/hooks/pre_tool_use.go:104
%% - Allow tool: internal/hooks/pre_tool_use.go:109
%%
%% Scenario 3 (PreToolUse auto-recovery on dirty tree, v3.8.0 - PR #3 fix):
%% - StopTriggered check: internal/hooks/pre_tool_use.go:88
%% - Tree capture: internal/hooks/pre_tool_use.go:89
%% - HEAD tree check: internal/hooks/pre_tool_use.go:94-98
%% - Diff recalculation: internal/hooks/pre_tool_use.go:114-121
%% - Threshold check: internal/hooks/pre_tool_use.go:124
%% - Clear StopTriggered: internal/hooks/pre_tool_use.go:125-127
%% - Allow tool: internal/hooks/pre_tool_use.go:137
%%
%% COMMIT PATTERN REGEX (Scenario 1)
%% Matches: git commit, git -C /path commit, git --git-dir=/x commit
%% Rejects: prose like "use git to commit"
%%
%% BENEFITS
%% 1. No manual /bumper-reset needed after ANY commit (Claude or external)
%% 2. Natural workflow: commit = checkpoint = fresh budget
%% 3. Encourages atomic commits (commit often, stay under threshold)
%% 4. Handles IDE commits, manual terminal commits (when threshold exceeded)
%% 5. PreToolUse timing (v3.7.0) checks BEFORE Write dirties tree (correct timing)
%% 6. Dynamic threshold checking (v3.8.0) auto-recovers when user reduces diff below threshold
%% 7. No manual intervention needed for partial file reversions (IDE undo, selective git checkout)
%%
%% EDGE CASES
%% 1. Scenario 1 fires immediately on commit (no delay)
%% 2. Scenario 2 fires on next Write/Edit after external commit (when StopTriggered=true)
%% 3. Scenario 2 only triggers when threshold exceeded (StopTriggered=true)
%% 4. Scenario 2 triggers when working tree == HEAD (clean tree):
%%    - External commits (IDE, terminal)
%%    - git reset --hard HEAD
%%    - Manual file reversions that match HEAD
%% 5. Scenario 3 (NEW v3.8.0) fires on next Write/Edit when tree dirty BUT score <= threshold:
%%    - User removes/reverts files via IDE
%%    - User runs `git checkout -- some-files` (partial revert)
%%    - User manually deletes uncommitted files
%%    - Any external change that reduces diff below threshold
%% 6. Scenario 3 updates score even if still over threshold (dynamic tracking)
%% 7. All scenarios handle untracked files correctly (CaptureTree includes them)
%% 8. Fail-open: If tree capture fails or HEAD unavailable, operations allowed (no blocking)
%%
%% PERFORMANCE NOTES
%% 1. CaptureTree() calls `git write-tree` which computes SHA1 hash of entire working tree
%%    - Walks all files, stats them, reads contents, computes object hashes
%%    - Cost: O(n) where n = number of files in repository
%%    - Typical cost: 50-100ms on modern hardware for medium repos
%% 2. Scenario 2 (PreToolUse clean tree check) runs CaptureTree() + GetHeadTree() when StopTriggered=true
%%    - Only triggers AFTER threshold exceeded (rare state)
%%    - Cost: ~120ms per Write/Edit in blocked state (tree check only)
%% 3. Scenario 3 (PreToolUse auto-recovery, v3.8.0) adds diff recalculation to Scenario 2's cost
%%    - When tree is dirty (not clean), also calculates diff score from baseline
%%    - Cost: ~125ms per Write/Edit in blocked state (tree check + diff calculation)
%%    - Only triggers when StopTriggered=true (rare - requires threshold breach)
%%    - Enables auto-recovery without manual /bumper-reset (UX benefit)
%% 4. Potential optimization (out of scope): Use `git diff-index --quiet HEAD`
%%    - Returns exit code 0 (clean) or 1 (dirty) without computing tree hash
%%    - Cost: ~10ms (90% faster than CaptureTree + GetHeadTree)
%%    - Trade-off: Doesn't provide tree SHA for baseline reset (would need follow-up call)
%%    - Requires deeper investigation of git-diff-index behavior with untracked files
