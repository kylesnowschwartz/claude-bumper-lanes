%% Auto-Reset: Invisible baseline capture when tree becomes clean
%% Render: cat auto-reset-commit-sequence.mmd | mermaid-ascii -f -
%% Focus: The "magic" that resets budget after commits (any source)

sequenceDiagram
    participant User
    participant Claude
    participant PreTU as PreToolUse
    participant PTU as PostToolUse
    participant Git
    participant Sess as Session

    %% ============================================================
    %% CASE 1: Claude commits via Bash tool
    %% ============================================================
    Note over User,Sess: Scenario 1: Claude commits
    User->>Claude: finish up and commit
    Claude->>Claude: (score at 350/400)

    %% Claude commits via Bash tool
    Claude->>Git: git commit -m "feat: add feature"
    Git-->>Claude: committed abc123

    %% PostToolUse fires for Bash
    PTU->>PTU: (regex matches git commit)
    PTU->>Git: CaptureTree()
    Git-->>PTU: tree SHA def456

    %% Reset baseline to committed state
    PTU->>Sess: baseline = def456
    PTU->>Sess: score = 0
    PTU-->>Claude: stderr: Auto-reset. Fresh budget: 400 pts.
    Claude-->>User: Committed. Fresh budget now.

    %% ============================================================
    %% CASE 2: PreToolUse auto-reset (v3.7.0)
    %% ============================================================
    Note over User,Sess: Scenario 2: PreToolUse catches external commit
    Note over User,Claude: (Threshold exceeded - StopTriggered=true)
    User->>Git: git commit (in IDE/terminal)
    Git-->>User: committed jkl012
    User->>Claude: continue working

    %% Claude attempts Write - PreToolUse fires BEFORE execution
    Claude->>PreTU as PreToolUse: (wants to Write file)

    %% PreToolUse checks state
    PreTU->>Sess: Load session
    Sess-->>PreTU: StopTriggered=true, score=450/400

    %% Auto-reset check (NEW in v3.7.0)
    Note over PreTU,Git: Clean tree check (handles external commits)
    PreTU->>Git: CaptureTree()
    Git-->>PreTU: tree SHA jkl012
    PreTU->>Git: GetHeadTree()
    Git-->>PreTU: HEAD tree jkl012

    %% Trees match - auto-reset and allow
    PreTU->>PreTU: (tree == HEAD, clean!)
    PreTU->>Git: GetCurrentBranch()
    Git-->>PreTU: main
    PreTU->>Sess: ResetBaseline(jkl012, main)
    PreTU->>Sess: StopTriggered = false
    PreTU->>Sess: score = 0

    %% Allow Write to proceed (no JSON output)
    PreTU-->>Claude: exit 0 (allow tool)
    Note over PreTU,Claude: No JSON = tool proceeds normally

    %% Write executes successfully
    Claude->>Git: Write file
    Git-->>Claude: file written

    %% PostToolUse calculates new score and provides feedback
    PTU->>PTU: handleWriteEdit()
    PTU->>Git: calculate diff from jkl012
    Git-->>PTU: score = 15 pts (just this Write)
    PTU->>Sess: score = 15
    PTU-->>Claude: stderr: Fresh budget after auto-reset. Score: 15/400 (3%)
    Claude-->>User: Changes made. Fresh budget: 15/400.

    %% ============================================================
%% VALIDATION REFERENCES
%% ============================================================
%% Scenario 1 (Claude commits):
%% - Commit detection: internal/hooks/post_tool_use.go:gitCommitPattern
%% - Tree capture: internal/hooks/post_tool_use.go:handleBashCommit (line 64)
%% - Reset call: internal/hooks/post_tool_use.go:handleBashCommit (line 72)
%% - Feedback: internal/hooks/post_tool_use.go:handleBashCommit (line 79)
%%
%% Scenario 2 (PreToolUse auto-reset, v3.7.0):
%% - StopTriggered check: internal/hooks/pre_tool_use.go:78
%% - Tree capture: internal/hooks/pre_tool_use.go:79
%% - HEAD tree check: internal/hooks/pre_tool_use.go:81
%% - Clean tree detection: internal/hooks/pre_tool_use.go:82
%% - Reset call: internal/hooks/pre_tool_use.go:85
%% - Allow tool: internal/hooks/pre_tool_use.go:90
%%
%% COMMIT PATTERN REGEX (Scenario 1)
%% Matches: git commit, git -C /path commit, git --git-dir=/x commit
%% Rejects: prose like "use git to commit"
%%
%% BENEFITS
%% 1. No manual /bumper-reset needed after ANY commit (Claude or external)
%% 2. Natural workflow: commit = checkpoint = fresh budget
%% 3. Encourages atomic commits (commit often, stay under threshold)
%% 4. Handles IDE commits, manual terminal commits (when threshold exceeded)
%% 5. PreToolUse timing (v3.7.0) checks BEFORE Write dirties tree (correct timing)
%%
%% EDGE CASES
%% 1. Scenario 1 fires immediately on commit (no delay)
%% 2. Scenario 2 fires on next Write/Edit after external commit (when StopTriggered=true)
%% 3. Scenario 2 only triggers when threshold exceeded (StopTriggered=true)
%% 4. Scenario 2 triggers when working tree == HEAD (clean tree):
%%    - External commits (IDE, terminal)
%%    - git reset --hard HEAD
%%    - Manual file reversions that match HEAD
%% 5. Scenario 2 does NOT trigger when working tree != HEAD (uncommitted changes)
%% 6. Both scenarios handle untracked files correctly (CaptureTree includes them)
%% 7. Fail-open: If tree capture fails or HEAD unavailable, threshold remains (no auto-reset)
