---
description: "Work package task list for Bumper Lanes plugin implementation"
last_updated: "2025-11-02T21:31:00Z"
revision: "v2 - Rewritten after user corrections"
---

# Work Packages: Bumper Lanes

**Inputs**: Design documents from `/kitty-specs/001-bumper-lanes/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/, quickstart.md

**Tests**: Not explicitly requested in spec - omitting test tasks per template guidelines.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; deep implementation detail lives in prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates subtask can proceed in parallel (different files/components).
- Includes precise file paths.

## Path Conventions (UPDATED)
- **Repository root**: `claude-bumper-lanes/`
- **Plugin root**: `bumper-lanes-plugin/` (subdirectory of repo)
- **Plugin manifest**: `bumper-lanes-plugin/.claude-plugin/plugin.json`
- **Hook registration**: `bumper-lanes-plugin/hooks/hooks.json`
- **Hook scripts**: `bumper-lanes-plugin/hooks/entrypoints/*.sh`
- **Library functions**: `bumper-lanes-plugin/hooks/lib/*.sh`
- **Commands**: `bumper-lanes-plugin/commands/*.md`
- **Marketplace config**: `.claude-plugin/marketplace.json` (at repo root)

---

## Work Package WP01: Plugin Infrastructure Setup (Priority: P0)

**Goal**: Establish plugin manifest, hook registration, directory structure. No configuration system for MVP (threshold hardcoded to 300 lines).
**Independent Test**: Plugin structure is complete, marketplace config enables local installation.
**Prompt**: `/tasks/planned/WP01-plugin-infrastructure-setup.md`

### Included Subtasks
- [ ] T001 Create `bumper-lanes-plugin/.claude-plugin/plugin.json` manifest (name: "bumper-lanes", no hooks/commands fields)
- [ ] T002 Create `bumper-lanes-plugin/hooks/hooks.json` registration (SessionStart, Stop ONLY - no SubagentStop, no UserPromptSubmit)
- [ ] T003 Create directory structure: `bumper-lanes-plugin/hooks/entrypoints/`, `bumper-lanes-plugin/hooks/lib/`, `bumper-lanes-plugin/commands/`
- [ ] T004 Create `.claude-plugin/marketplace.json` at repo root (source: "./bumper-lanes-plugin")

### Implementation Notes
- Plugin manifest uses minimal format (Claude Code discovers hooks/commands by directory convention)
- Hook registration includes SessionStart and Stop ONLY (SubagentStop excluded from MVP)
- No config file or config-loader.sh (threshold hardcoded to 300)
- All hook scripts must be executable (`chmod +x`)

### Parallel Opportunities
- All subtasks are independent file creation operations (T001-T004 can proceed in parallel)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Invalid JSON schema ‚Üí validate with `jq` before committing
- Wrong directory structure ‚Üí reference `/Users/kyle/Code/meta-claude/SimpleClaude/plugins/sc-hooks/` for example

---

## Work Package WP02: Shared Hook Utilities (Priority: P0)

**Goal**: Implement reusable bash library functions for git operations, session state management, and threshold calculation. No configuration loader (threshold hardcoded).
**Independent Test**: Each library script sources successfully and exports documented functions; smoke test with simple invocations.
**Prompt**: `/tasks/planned/WP02-shared-hook-utilities.md`

### Included Subtasks
- [ ] T005 [P] Implement `bumper-lanes-plugin/hooks/lib/git-state.sh` (capture_tree, compute_diff)
- [ ] T007 [P] Implement `bumper-lanes-plugin/hooks/lib/state-manager.sh` (sessionId-based, write/read only - no cleanup)
- [ ] T008 [P] Implement `bumper-lanes-plugin/hooks/lib/threshold.sh` (calculate_threshold, parse_diff_stats)

### Implementation Notes
- **git-state.sh**:
  - `capture_tree()`: Use temporary index approach with `GIT_INDEX_FILE`, return tree SHA
  - `compute_diff()`: Run `git diff-tree --shortstat $baseline $current`, parse line counts
- **state-manager.sh**:
  - State files: `.git/bumper-checkpoints/session-{sessionId}` (UUID-based, not PID)
  - JSON schema: `{"session_id", "baseline_tree", "created_at", "threshold_limit": 300, "repo_path"}`
  - No cleanup logic for MVP (cleanup in v2)
- **threshold.sh**:
  - Extract additions and deletions from git diff-tree output
  - Return total lines changed (additions + deletions)
  - Threshold hardcoded to 300 in state-manager.sh

### Parallel Opportunities
- All library modules are independent (T005, T007, T008 can proceed in parallel)

### Dependencies
- Depends on WP01 (directory structure must exist)

### Risks & Mitigations
- Git command failures ‚Üí implement fail-open error handling (log to stderr, return safe defaults)
- Missing jq dependency ‚Üí document in README prerequisites

---

## Work Package WP03: Automatic Threshold Enforcement (Priority: P1) üéØ MVP

**Goal**: Implement SessionStart baseline capture and Stop threshold checking. No SessionEnd cleanup for MVP. SessionId-based state isolation.
**Independent Test**: Start Claude session, make incremental changes, verify threshold block message appears when 300-line limit exceeded.
**Prompt**: `/tasks/planned/WP03-automatic-threshold-enforcement.md`

### Included Subtasks
- [ ] T009 Implement `bumper-lanes-plugin/hooks/entrypoints/session-start.sh` (baseline capture, sessionId extraction from stdin `.sessionId`)
- [ ] T010 Implement `bumper-lanes-plugin/hooks/entrypoints/stop.sh` (threshold check, block logic, sessionId extraction)

### Implementation Notes
- **session-start.sh**:
  1. Read stdin JSON (working_directory, sessionId)
  2. Check `git rev-parse --git-dir` ‚Üí if fails, exit 0 (disable plugin)
  3. Call `capture_tree()` from git-state.sh
  4. Call `write_session_state(sessionId, baseline_tree)` (threshold hardcoded to 300 in state-manager.sh)
  5. Exit 0
- **stop.sh**:
  1. Read stdin JSON (hook_name, working_directory, sessionId)
  2. Call `read_session_state(sessionId)` ‚Üí if missing, output null and exit 0
  3. Call `capture_tree()` for current state
  4. Call `compute_diff(baseline, current)`
  5. Call `calculate_threshold()` with diff stats
  6. If under 300: output null, exit 0
  7. If over 300: output block JSON with decision="block", reason with stats and /bumper-reset instruction, exit 0
  8. On error: log stderr, output null, exit 0 (fail open)
- **No session-end.sh** (no cleanup for MVP - session state files persist)
- **No SubagentStop registration** (subagents unpredictable, excluded from MVP)

### Parallel Opportunities
- T009 must complete before T010 can be tested (baseline must exist for threshold check)

### Dependencies
- Depends on WP02 (library functions must exist)

### Risks & Mitigations
- Baseline missing on Stop hook ‚Üí fail open with null output (handled in step 2 of stop.sh)
- Git errors during diff computation ‚Üí fail open with null output (error handling in compute_diff)
- SessionId extraction fails ‚Üí hook stdin always provides `.sessionId` field (Claude Code standard)

---

## Work Package WP04: Consent Mechanism (Priority: P1) üéØ MVP

**Goal**: Implement `/bumper-reset` command that resets baseline via bash script execution (using `!` syntax, not UserPromptSubmit hook).
**Independent Test**: Trigger threshold block, execute `/bumper-reset`, verify baseline resets and Claude can continue.
**Prompt**: `/tasks/planned/WP04-consent-mechanism.md`

### Included Subtasks
- [ ] T013 Implement `bumper-lanes-plugin/hooks/entrypoints/reset-baseline.sh` (standalone script, NOT a hook, receives sessionId as $1)
- [ ] T014 Create `/bumper-reset` command spec at `bumper-lanes-plugin/commands/bumper-reset.md` (uses `!${CLAUDE_PLUGIN_ROOT}/hooks/entrypoints/reset-baseline.sh ${CLAUDE_SESSION_ID}`)

### Implementation Notes
- **reset-baseline.sh**:
  1. Read sessionId from command-line argument ($1)
  2. Call `read_session_state(sessionId)` ‚Üí if missing, print error message, exit 0
  3. Capture old baseline_tree for reporting
  4. Call `compute_diff(old_baseline, current)` for "changes accepted" stats
  5. Call `capture_tree()` for new baseline
  6. Update session state with new baseline_tree via `write_session_state(sessionId, new_baseline)`
  7. Build confirmation message: old/new baseline SHAs (truncated to 7 chars), changes accepted stats, fresh budget
  8. Print confirmation to stdout (user sees directly)
  9. Exit 0
- **bumper-reset.md**:
  - Frontmatter with title, description, usage, category
  - Implementation section with `!` syntax execution: `!${CLAUDE_PLUGIN_ROOT}/hooks/entrypoints/reset-baseline.sh ${CLAUDE_SESSION_ID}`
  - Example output showing old/new baseline and "Pick up where we left off?"

### Parallel Opportunities
- T013 and T014 are independent (command spec can be written while script is implemented)

### Dependencies
- Depends on WP02 (library functions)
- Depends on WP03 (session state must exist for reset to work)

### Risks & Mitigations
- Reset when not blocked ‚Üí handled gracefully (updates baseline anyway, no harm)
- SessionId not passed to script ‚Üí `${CLAUDE_SESSION_ID}` is standard Claude Code environment variable

---

## Work Package WP05: Documentation and Distribution (Priority: P2)

**Goal**: Create README with installation, usage, architecture, troubleshooting. Verify marketplace config.
**Independent Test**: New developer can follow README to install plugin locally (under 10 minutes) and trigger threshold enforcement.
**Prompt**: `/tasks/planned/WP05-documentation-and-distribution.md`

### Included Subtasks
- [ ] T015 Create `README.md` at repository root (installation, quick start, architecture, troubleshooting)
- [ ] T016 Verify `.claude-plugin/marketplace.json` created in WP01 T004 (already exists, just validate)

### Implementation Notes
- **README.md**:
  - Document directory structure (repo root vs plugin subdirectory)
  - Installation section: local development method only for MVP
  - Architecture section: directory structure diagram, hook lifecycle explanation
  - Troubleshooting section: common issues (not git repo, baseline not captured, threshold not blocking)
  - Link to quickstart.md for detailed scenarios
- **marketplace.json verification**:
  - Confirm file exists at `.claude-plugin/marketplace.json` (repo root, NOT inside bumper-lanes-plugin/)
  - Validate JSON syntax with `jq`
  - Test installation: `/plugin marketplace add .` ‚Üí `/plugin install bumper-lanes@local-dev`

### Parallel Opportunities
- T015 and T016 are independent (README and marketplace verification can proceed in parallel)

### Dependencies
- Depends on WP01-WP04 (all implementation complete for documentation accuracy)

### Risks & Mitigations
- README too long ‚Üí keep concise, link to quickstart.md for details
- Installation steps unclear ‚Üí test on clean environment before finalizing

---

## Dependency & Execution Summary

**Sequence**: WP01 ‚Üí WP02 ‚Üí (WP03 || WP04) ‚Üí WP05

- **WP01** (Plugin Infrastructure) must complete first (establishes directory structure)
- **WP02** (Shared Utilities) depends on WP01 (needs directories to exist)
- **WP03** (Threshold Enforcement) and **WP04** (Consent) depend on WP02 (use library functions)
- **WP03** and **WP04** can proceed in parallel after WP02 completes
- **WP05** (Documentation) depends on WP03 and WP04 (needs complete implementation for accuracy)

**Parallelization**:
- Within WP01: T001-T004 (all independent file creation)
- Within WP02: T005, T007, T008 (all independent library modules)
- Between WP03 and WP04: Can proceed concurrently once WP02 completes
- Within WP05: T015-T016 (README and marketplace verification independent)

**MVP Scope**: WP01 + WP02 + WP03 + WP04 (11 subtasks)
- Delivers automatic threshold enforcement and consent mechanism
- Minimum viable implementation of P1 user stories
- WP05 (documentation) recommended but technically optional for functional MVP

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? | Notes |
|------------|---------|--------------|----------|-----------|-------|
| T001 | Create plugin.json manifest | WP01 | P0 | Yes | Minimal format, no hooks/commands fields |
| T002 | Create hooks.json registration | WP01 | P0 | Yes | SessionStart, Stop ONLY (no SubagentStop) |
| T003 | Create directory structure | WP01 | P0 | Yes | entrypoints/, lib/, commands/ |
| T004 | Create marketplace.json | WP01 | P0 | Yes | At repo root, source="./bumper-lanes-plugin" |
| T005 | Implement git-state.sh library | WP02 | P0 | Yes | capture_tree, compute_diff |
| T007 | Implement state-manager.sh library | WP02 | P0 | Yes | SessionId-based, write/read only |
| T008 | Implement threshold.sh library | WP02 | P0 | Yes | calculate_threshold, parse_diff_stats |
| T009 | Implement session-start.sh hook | WP03 | P1 | No | SessionId extraction, baseline capture |
| T010 | Implement stop.sh hook | WP03 | P1 | No | Threshold check, block logic |
| T013 | Implement reset-baseline.sh script | WP04 | P1 | No | Standalone script, NOT a hook |
| T014 | Create bumper-reset.md command spec | WP04 | P1 | Yes | Uses ! syntax execution |
| T015 | Create README.md | WP05 | P2 | Yes | Installation, architecture, troubleshooting |
| T016 | Verify marketplace.json | WP05 | P2 | Yes | Already created in WP01 T004 |

---

## Key Architectural Changes from Original Plan

**Directory Structure**:
- Plugin lives in `bumper-lanes-plugin/` subdirectory (not at repo root)
- Marketplace config at repo root: `.claude-plugin/marketplace.json`
- Hook scripts in `hooks/entrypoints/` (not `hooks/scripts/`)
- Library functions in `hooks/lib/` (not `hooks/scripts/lib/`)

**Deleted Features (MVP Scope Reduction)**:
- ‚ùå No SubagentStop hook (subagents unpredictable)
- ‚ùå No UserPromptSubmit hook (use ! syntax instead)
- ‚ùå No config system (threshold hardcoded to 300)
- ‚ùå No cleanup logic (session state files persist)
- ‚ùå No session-end.sh hook (no cleanup needed)
- ‚ùå No config-loader.sh library (no config to load)

**Changed Implementation**:
- ‚úÖ SessionId-based state (changed from PID-based to conversation UUID)
- ‚úÖ `/bumper-reset` uses ! syntax to execute bash script directly (no hook)
- ‚úÖ reset-baseline.sh receives sessionId as command-line argument
- ‚úÖ Confirmation message ends with "Pick up where we left off?"

**Subtask Count Change**:
- Original: 17 subtasks (T001-T017)
- Updated: 13 subtasks (deleted T006, T011, T012, T017)

---

**Total**: 5 work packages, 13 subtasks (11 for MVP, 2 for documentation)

**Last Updated**: 2025-11-02T21:31:00Z (rewritten after user corrections)
