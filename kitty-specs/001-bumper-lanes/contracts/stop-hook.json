{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Stop Hook Contract",
  "description": "Contract for stop.sh hook that checks diff threshold and blocks if exceeded",

  "stdin": {
    "type": "object",
    "description": "Input received from Claude Code on Stop event",
    "properties": {
      "hook_name": {
        "type": "string",
        "enum": ["Stop", "SubagentStop"],
        "description": "Hook event type - Stop for main agent, SubagentStop for subagents"
      },
      "session_id": {
        "type": "string",
        "description": "Session identifier"
      },
      "working_directory": {
        "type": "string",
        "description": "Current working directory path"
      }
    },
    "required": ["hook_name", "working_directory"]
  },

  "stdout": {
    "description": "JSON response indicating whether to block agent from stopping",
    "oneOf": [
      {
        "type": "object",
        "description": "Block response when threshold exceeded",
        "properties": {
          "decision": {
            "type": "string",
            "const": "block",
            "description": "Block the agent from stopping"
          },
          "reason": {
            "type": "string",
            "description": "Human-readable explanation with diff stats and instructions",
            "pattern": "^Diff threshold exceeded:.*"
          },
          "diff_stats": {
            "type": "object",
            "description": "Optional detailed statistics for debugging",
            "properties": {
              "files_changed": {"type": "integer"},
              "lines_added": {"type": "integer"},
              "lines_deleted": {"type": "integer"},
              "total_lines_changed": {"type": "integer"},
              "threshold_limit": {"type": "integer"},
              "threshold_percentage": {"type": "number"}
            }
          }
        },
        "required": ["decision", "reason"]
      },
      {
        "type": "null",
        "description": "Allow response when threshold not exceeded or plugin disabled"
      }
    ]
  },

  "stderr": {
    "description": "Error messages if threshold check fails (non-fatal)",
    "type": "string"
  },

  "exit_code": {
    "description": "Exit code indicating success or failure",
    "enum": [0, 1],
    "codes": {
      "0": "Success - threshold check completed",
      "1": "Error - threshold check failed (fail open, allow stop)"
    }
  },

  "side_effects": {
    "description": "Side effects produced by this hook",
    "effects": [
      {
        "type": "filesystem",
        "path": ".git/bumper-checkpoints/stats-$$",
        "action": "create_or_update",
        "content": "Cached diff statistics (optional optimization)"
      },
      {
        "type": "filesystem",
        "path": ".git/bumper-checkpoints/blocks.log",
        "action": "append",
        "content": "JSONL log of block events (optional)"
      }
    ]
  },

  "behavior": {
    "description": "Hook behavior specification",
    "steps": [
      "1. Load session state from .git/bumper-checkpoints/session-$$",
      "2. If session state missing, exit 0 with null output (allow stop, no baseline)",
      "3. Capture current working tree as tree object",
      "4. Compute diff statistics: git diff-tree --shortstat baseline_tree current_tree",
      "5. Parse line counts (additions + deletions = total_lines_changed)",
      "6. If total_lines_changed <= threshold_limit: output null, exit 0 (allow stop)",
      "7. If total_lines_changed > threshold_limit:",
      "   - Build block message with stats and /bumper-reset instruction",
      "   - Output JSON with decision=block and reason",
      "   - Cache stats to stats-$$ file",
      "   - Log block event to blocks.log",
      "   - Exit 0",
      "8. On any error: log to stderr, output null, exit 0 (fail open)"
    ],
    "error_handling": "Fail open - if baseline missing, git commands fail, or threshold check errors, allow stop with null output"
  },

  "example_outputs": {
    "allow": null,
    "block": {
      "decision": "block",
      "reason": "Diff threshold exceeded: 430/300 lines changed (143%).\n\nChanges:\n  8 files changed, 287 insertions(+), 143 deletions(-)\n\nReview your changes and run /bumper-reset to continue.",
      "diff_stats": {
        "files_changed": 8,
        "lines_added": 287,
        "lines_deleted": 143,
        "total_lines_changed": 430,
        "threshold_limit": 300,
        "threshold_percentage": 143.3
      }
    }
  }
}
