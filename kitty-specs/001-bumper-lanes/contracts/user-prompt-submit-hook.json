{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "UserPromptSubmit Hook Contract",
  "description": "Contract for user-prompt-submit.sh hook that detects /bumper-reset command",

  "stdin": {
    "type": "object",
    "description": "Input received from Claude Code on UserPromptSubmit event (SCHEMA NOT YET EMPIRICALLY VERIFIED - needs testing)",
    "properties": {
      "session_id": {
        "type": "string",
        "format": "uuid",
        "description": "Unique session identifier (conversation UUID)"
      },
      "transcript_path": {
        "type": "string",
        "description": "Path to JSONL transcript file"
      },
      "cwd": {
        "type": "string",
        "description": "Current working directory (project root) - hook is executed in this directory"
      },
      "permission_mode": {
        "type": "string",
        "description": "Current permission mode (e.g., 'bypassPermissions', 'default')"
      },
      "hook_event_name": {
        "type": "string",
        "const": "UserPromptSubmit",
        "description": "Hook event type"
      },
      "prompt": {
        "type": "string",
        "description": "The user's submitted prompt text"
      }
    },
    "required": ["session_id", "transcript_path", "cwd", "permission_mode", "hook_event_name", "prompt"]
  },

  "stdout": {
    "description": "JSON response with hookSpecificOutput when /bumper-reset detected, null otherwise",
    "oneOf": [
      {
        "type": "object",
        "description": "Response when /bumper-reset command detected in prompt",
        "properties": {
          "hookSpecificOutput": {
            "type": "object",
            "properties": {
              "hookEventName": {
                "type": "string",
                "const": "UserPromptSubmit"
              },
              "additionalContext": {
                "type": "string",
                "description": "Output from reset-baseline.sh script (confirmation message or error)"
              }
            },
            "required": ["hookEventName", "additionalContext"]
          }
        },
        "required": ["hookSpecificOutput"]
      },
      {
        "type": "null",
        "description": "Allow response when /bumper-reset not in prompt"
      }
    ]
  },

  "stderr": {
    "description": "Error messages if reset fails",
    "type": "string"
  },

  "exit_code": {
    "description": "Exit code indicating success or failure",
    "enum": [0, 1],
    "codes": {
      "0": "Success - prompt processed",
      "1": "Error - non-blocking"
    }
  },

  "side_effects": {
    "description": "Side effects when /bumper-reset command detected",
    "effects": [
      {
        "type": "filesystem",
        "path": ".git/bumper-checkpoints/session-$$",
        "action": "update",
        "content": "Update baseline_tree to current working tree SHA"
      },
      {
        "type": "filesystem",
        "path": ".git/bumper-checkpoints/stats-$$",
        "action": "delete",
        "content": "Clear cached statistics"
      },
      {
        "type": "context_injection",
        "target": "claude",
        "content": "Confirmation message that baseline was reset and threshold budget restored"
      }
    ]
  },

  "behavior": {
    "description": "Hook behavior specification",
    "steps": [
      "1. Read user prompt from stdin JSON",
      "2. Check if prompt contains /bumper-reset command (exact match or with args)",
      "3. If not /bumper-reset: output null, exit 0 (no-op)",
      "4. If /bumper-reset detected:",
      "   - Load session state from .git/bumper-checkpoints/session-$$",
      "   - If session missing: inject error message to Claude, exit 0",
      "   - Capture current working tree as new baseline",
      "   - Compute final diff stats before reset (for reporting)",
      "   - Update session file with new baseline_tree",
      "   - Clear stats cache if exists",
      "   - Build confirmation message with old/new baseline and accepted changes",
      "   - Output JSON with additionalContext containing confirmation",
      "   - Exit 0",
      "5. On error: log to stderr, inject error message to Claude, exit 0 (fail open)"
    ],
    "command_detection": {
      "exact_match": "/bumper-reset",
      "with_args": "/bumper-reset force",
      "case_sensitivity": "case-sensitive",
      "must_be_command": "Must be at start of line or after whitespace, not mid-word"
    }
  },

  "example_outputs": {
    "no_reset": null,
    "reset_success": {
      "hookSpecificOutput": {
        "hookEventName": "UserPromptSubmit",
        "additionalContext": "✓ Baseline reset complete.\n\nPrevious baseline: 3a4b5c6 (captured 2025-11-02 20:15:00)\nNew baseline: 1f2e3d4 (captured 2025-11-02 20:45:30)\n\nChanges accepted: 8 files, 287 insertions(+), 143 deletions(-) [430 lines total]\n\nYou now have a fresh diff budget of 300 lines. Pick up where we left off?"
      }
    },
    "reset_error_no_session": {
      "hookSpecificOutput": {
        "hookEventName": "UserPromptSubmit",
        "additionalContext": "⚠ Bumper Lanes: No active session found. Baseline reset skipped."
      }
    }
  },

  "notes": [
    "This hook is critical for the consent mechanism - user explicitly approves changes",
    "After reset, diff counter restarts from zero with new baseline",
    "Old baseline tree persists in git objects (no data loss)",
    "Confirmation message should be informative but concise (Claude sees it as context)",
    "Consider future extension: /bumper-reset --dry-run to show what would be accepted"
  ]
}
