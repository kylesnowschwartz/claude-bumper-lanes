{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SessionStart Hook Contract",
  "description": "Contract for session-start.sh hook that captures baseline tree on session initialization",

  "stdin": {
    "type": "object",
    "description": "Input received from Claude Code on SessionStart event (EMPIRICALLY VERIFIED 2025-11-02)",
    "properties": {
      "session_id": {
        "type": "string",
        "format": "uuid",
        "description": "Unique session identifier (conversation UUID)"
      },
      "transcript_path": {
        "type": "string",
        "description": "Path to JSONL transcript file"
      },
      "cwd": {
        "type": "string",
        "description": "Current working directory (project root) - hook is executed in this directory"
      },
      "hook_event_name": {
        "type": "string",
        "const": "SessionStart",
        "description": "Hook event type"
      },
      "source": {
        "type": "string",
        "enum": ["startup", "resume", "clear", "compact"],
        "description": "Session trigger source"
      }
    },
    "required": ["session_id", "transcript_path", "cwd", "hook_event_name", "source"]
  },

  "stdout": {
    "description": "No structured output required. Hook should write baseline state to .git/bumper-checkpoints/session-$$ file",
    "type": "null"
  },

  "stderr": {
    "description": "Error messages if baseline capture fails (non-fatal, plugin should fail open)",
    "type": "string"
  },

  "exit_code": {
    "description": "Exit code indicating success or failure",
    "enum": [0, 1],
    "codes": {
      "0": "Success - baseline captured",
      "1": "Error - baseline capture failed (non-blocking)"
    }
  },

  "side_effects": {
    "description": "Side effects produced by this hook",
    "effects": [
      {
        "type": "filesystem",
        "path": ".git/bumper-checkpoints/session-$$",
        "action": "create",
        "content": "JSON file containing session state with baseline tree SHA"
      },
      {
        "type": "environment",
        "variable": "BUMPER_BASELINE_TREE",
        "action": "set",
        "scope": "session",
        "description": "Written to CLAUDE_ENV_FILE for subsequent bash commands"
      }
    ]
  },

  "behavior": {
    "description": "Hook behavior specification",
    "steps": [
      "1. Check if working directory is a git repository (git rev-parse --git-dir)",
      "2. If not git repo, exit 0 (disable plugin gracefully)",
      "3. Create .git/bumper-checkpoints/ directory if not exists",
      "4. Capture current working tree as baseline tree using temporary index approach",
      "5. Load threshold configuration (repo > user > default)",
      "6. Write session state file with baseline_tree, pid, threshold_limit, created_at",
      "7. Export BUMPER_BASELINE_TREE to CLAUDE_ENV_FILE",
      "8. Exit 0"
    ],
    "error_handling": "Fail open - if any step fails, log to stderr and exit 0 to avoid blocking session start"
  },

  "example_session_state_file": {
    "pid": 12345,
    "baseline_tree": "3a4b5c6d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b",
    "created_at": "2025-11-02T20:15:00Z",
    "threshold_limit": 300,
    "repo_path": "/Users/kyle/Code/my-projects/example-repo"
  }
}
